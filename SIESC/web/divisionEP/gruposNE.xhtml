<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
    <body>
        <ui:composition template="./templateDEP.xhtml">

            <ui:define name="content">
            
                   
                <f:view>
                   
                    <f:metadata>
                        <f:event type="preRenderView" listener="#{horarioCrearBean.resetearSiEsRecarga}" />
                    </f:metadata>
                    <h:form id="horarioG" style="width:100%;  margin:auto; margin-top:0px;">
                        <h:outputScript>
                            var maximoSeleccion = #{horarioCrearBean.creditos};
                        </h:outputScript> 
                        <p:panel header="CREAR GRUPO: "  styleClass="panel-crear-grupo">
                            <p:panelGrid columns="4" styleClass="ui-fluid panelgrid-compacto"  columnClasses="ui-g-12 ui-md-3"  style="gap:20px;">
                                <p:outputLabel for="carrera" value="CARRERA:"/>
                                <p:outputLabel for="periodo" value="PERIODO:"/>
                                <p:outputLabel for="semestre" value="SEMESTRE:"/>
                                <p:outputLabel for="asignatura" value="ASIGNATURA: " />
                                
                                
                                <p:selectOneMenu id="carrera" value="#{horarioCrearBean.carreraS}"
                                                 styleClass="select-medio"
                                                 filter="true" 
                                                 filterMatchMode="contains" 
                                                 disabled="#{horarioCrearBean.desactivarCampos}"  style="width:100%;" >
                                    
                                    <p:ajax listener="#{horarioCrearBean.cambioCarrera}" update="asignatura semestre grupo panelBotones panelBotonesModoGrupoAulas"/>
                                    <f:selectItem itemLabel="SELECCIONA CARRERA" itemValue="" noSelectionOption="true"/>
                                    <f:selectItems value="#{horarioCrearBean.listaPermisos}" var="listaPermiso" itemLabel="#{listaPermiso.reticula.nombreCarrera}" itemValue="#{listaPermiso.reticula.reticula}"/>
                                </p:selectOneMenu>


                                <p:selectOneMenu id="periodo" 
                                                 value="#{horarioCrearBean.periodoS}" 
                                                 style="width:100%" 
                                                 filter="true" 
                                                 filterMatchMode="contains"
                                                 disabled="#{horarioCrearBean.desactivarCampos}"  styleClass="select-medio" >                                    
                                    <p:ajax listener="#{horarioCrearBean.cambioPeriodo}" update="grupo panelBotones panelBotonesModoGrupoAulas"/>
                                    <f:selectItem itemLabel="SELECCIONA UN PERIODO" itemValue="" noSelectionOption="true"/>
                                    <f:selectItems value="#{horarioCrearBean.listaPeriodoEscolar}" var="listaPeriodo" itemLabel="#{listaPeriodo.identificacionCorta}" itemValue="#{listaPeriodo.periodo}"/>
                                </p:selectOneMenu>


                                <p:selectOneMenu id="semestre" 
                                                 value="#{horarioCrearBean.semestreS}" 
                                                
                                                 filter="true" 
                                                 filterMatchMode="contains"
                                                 disabled="#{horarioCrearBean.desactivarCampos}" styleClass="select-medio" style="width:100%;">                                    
                                    <p:ajax listener="#{horarioCrearBean.cambioSemestre}" update="asignatura grupo panelBotones panelBotonesModoGrupoAulas" />
                                    <f:selectItem itemLabel="SELECCIONA UN SEMESTRE" itemValue="0" noSelectionOption="true"/>
                                    <f:selectItem itemLabel="SEMESTRE 1" itemValue="1"/>
                                    <f:selectItem itemLabel="SEMESTRE 2" itemValue="2"/>
                                    <f:selectItem itemLabel="SEMESTRE 3" itemValue="3"/>
                                    <f:selectItem itemLabel="SEMESTRE 4" itemValue="4"/>
                                    <f:selectItem itemLabel="SEMESTRE 5" itemValue="5"/>
                                    <f:selectItem itemLabel="SEMESTRE 6" itemValue="6"/>
                                    <f:selectItem itemLabel="SEMESTRE 7" itemValue="7"/>
                                    <f:selectItem itemLabel="SEMESTRE 8" itemValue="8"/>
                                    <f:selectItem itemLabel="SEMESTRE 9" itemValue="9"/>
                                </p:selectOneMenu>

                               
                            
                                <p:selectOneMenu id="asignatura" 
                                                 value="#{horarioCrearBean.asignaturaS}" 
                                                
                                                 filter="true" 
                                                 filterMatchMode="contains"
                                                 disabled="#{horarioCrearBean.desactivarCampos}" styleClass="select-medio" style="width:100%;">

                                    <p:ajax listener="#{horarioCrearBean.actualizarCreditos}" 
                                            update="grupo panelBotones panelBotonesModoGrupoAulas"
                                            oncomplete="maximoSeleccion = args.creditos; console.log('Nuevo maximoSeleccion:', maximoSeleccion);" />

                                    <f:selectItem itemLabel="SELECCIONA ASIGNATURA" itemValue="" noSelectionOption="true" />
                                    <f:selectItems value="#{horarioCrearBean.listaMateria}" 
                                                   var="listaAsignatura" 
                                                   itemLabel="#{listaAsignatura.materia.nombreCompletoMateria}" 
                                                   itemValue="#{listaAsignatura.idMateriaCarrera}" />
                                </p:selectOneMenu>

                                <p:outputLabel for="aulas" value="AULA:"/> 
                                <p:outputLabel for="grupos" value="NOMBRE GRUPO:" />
                                <p:outputLabel for="capgrupos" value="ESTUDIANTES"/>
                                <p:outputLabel for="panelBotonesModoGrupoAulas" value=""/>
                                <p:selectOneMenu id="aulas" 
                                                 value="#{horarioCrearBean.aulas}"
                                                 filter="true" 
                                                 filterMatchMode="contains" 
                                                 disabled="#{horarioCrearBean.desactivarCampos}" styleClass="select-medio" style="width:100%;">
                                    <p:ajax listener="#{horarioCrearBean.cambioAula}" update="grupo panelBotones panelBotonesModoGrupoAulas" />
                                    <f:selectItem itemLabel="SELECCIONA AULA" itemValue="" noSelectionOption="true"/>
                                    <f:selectItems value="#{horarioCrearBean.listaAulas}" var="listaAulas" itemLabel="#{listaAulas.aula}" itemValue="#{listaAulas.aula}"/>
                                </p:selectOneMenu>

                                <p:inputText id="grupos"
                                             maxlength="3"
                                             value="#{horarioCrearBean.valorgrupo}"
                                             title="Namegroup"
                                             required="true"
                                             requiredMessage="CAMPO NOMBRE GRUPO ES OBLIGATORIO."
                                             style="width:275px"
                                             disabled="#{horarioCrearBean.desactivarCampos}">
                                    <!-- Este bloque hace que al escribir o cambiar, se llame al m√©todo -->
                                    <p:ajax event="input" listener="#{horarioCrearBean.cambioGrupo}" update="grupo panelBotones panelBotonesModoGrupoAulas" process="@this"/>

                                </p:inputText>

                                <p:inputNumber id="capgrupos" 
                                               value="#{horarioCrearBean.numestudiantes}" 
                                               required="true" 
                                               requiredMessage="El campo es obligatorio"
                                               minValue="0"
                                               maxValue="100"      
                                               inputStyle="width:275px"
                                               disabled="#{horarioCrearBean.desactivarCampos}">
                                    <p:ajax />
                                </p:inputNumber>

         
                        <h:panelGroup id="panelBotonesModoGrupoAulas"
                                      layout="block"
                                      style="display:flex; justify-content: right; gap:10px; margin-bottom:0px; ">

                            <!-- √çcono Modo Aula -->
                            <p:commandButton icon="pi pi-building"
                                             title="Modo Aula"
                                             styleClass="btn-modo btn-modo-aula"
                                             actionListener="#{horarioCrearBean.actualizarTablaPorAula}"
                                             update="grupo growl panelBotonesModoGrupoAulas panelBotonesModoGrupoAulas panelBotones"
                                             oncomplete="desactivandoModoTodo(); activarModoAula();"
                                             disabled="#{!horarioCrearBean.booleanBotonAula 
                                                         or horarioCrearBean.desactivarCampos}"/>

                            <!-- √çcono Modo Grupo -->
                            <p:commandButton icon="pi pi-users"
                                             title="Modo Grupo"
                                             styleClass="btn-modo btn-modo-grupo"
                                             actionListener="#{horarioCrearBean.actualizarTablaPorGrupo}"
                                             update="grupo growl panelBotonesModoGrupoAulas panelBotonesModoGrupoAulas panelBotones"
                                             oncomplete="desactivandoModoTodo(); activarModoGrupo();"
                                             disabled="#{!horarioCrearBean.booleanBotonGrupo
                                                         or horarioCrearBean.desactivarCampos}"/>
                        </h:panelGroup>
                                
                                  <p:growl id="growl" showDetail="true" sticky="false" life="4000"/>

                          
                            
                            
                            
                            
                            </p:panelGrid>




                           
                            
<h:panelGroup layout="block" styleClass="legend-wrapper">

    <div class="legend-container">
        <div class="legend-header">SIMBOLOG√çA DE ESTADOS</div>

        <div class="legend-row">
            <div class="legend-cell celda-seleccionada">
                Celda seleccionada
            </div>

            <div class="legend-cell celda-insertada">
                Celda insertada / agregada
            </div>

            <div class="legend-cell resaltarEliminar">
                Elemento marcado para eliminar
            </div>

            <div class="legend-cell celda-intercambio">
                Intercambio confirmado
            </div>

            <div class="legend-cell celda-hover-intercambio">
                Intercambio (hover)
            </div>

            <div class="legend-cell celda-hover-modificar">
                Modificar (hover)
            </div>

            <div class="legend-cell celda-hover-eliminar">
                Eliminar (hover)
            </div>

            <div class="legend-cell celda-hover-agregar">
                Agregar (hover)
            </div>
        </div>
    </div>

</h:panelGroup>
                             <p:divider />
                            <p:panelGrid id="panelBotones" columns="4" styleClass="ui-fluid panel-botones-sin-borde" columnClasses="ui-g-12 ui-md-3">
                                <p:commandButton value="Insertar Materia"
                                                 icon="pi pi-save"     
                                                 iconPos="left"             
                                                 onclick="window.onbeforeunload = null; guardarSeleccionadas()"
                                                 action="#{horarioCrearBean.generarHorario()}" 
                                                 id="btnguardar"                               
                                                 update="panelBotones growl grupo"
                                                 styleClass="btn-inst btn-inst-insertar"
                                                 disabled="#{horarioCrearBean.eliminando 
                                                             or horarioCrearBean.activarModificar 
                                                             or horarioCrearBean.modoIntercambio 
                                                             or !horarioCrearBean.booleanBotonInsertar}" /> 

                                <p:commandButton 
                                    value="Eliminar Materia" 
                                    icon="pi pi-trash" 
                                    title="Selecciona la materia a eliminar"
                                    actionListener="#{horarioCrearBean.activarEliminar}"
                                    oncomplete="activarModoEliminarJS();"
                                    update="panelBotones growl grupo confirmEliminarDialog 
                                    carrera periodo semestre asignatura aulas grupos capgrupos panelBotonesModoGrupoAulas"
                                    process="@this"
                                    styleClass="btn-inst btn-inst-eliminar"
                                    disabled="#{!horarioCrearBean.booleanBotonEliminar 
                                                or horarioCrearBean.activarModificar 
                                                or horarioCrearBean.modoIntercambio}"
                                    >
                                </p:commandButton>

                                <p:commandButton  
                                    value="Modificar Aula"  
                                    icon="pi pi-pencil"  
                                    title="Selecciona una materia para modificar su aula"
                                    actionListener="#{horarioCrearBean.activarModoModificar}"  
                                    oncomplete="activarModoModificarJS();"  
                                    update="panelBotones growl grupo confirmModificarDialog 
                                    carrera periodo semestre asignatura aulas grupos capgrupos panelBotonesModoGrupoAulas"
                                    process="@this"
                                    styleClass="btn-inst btn-inst-modificar"
                                    disabled="#{!horarioCrearBean.booleanBotonModificar 
                                                or horarioCrearBean.eliminando 
                                                or horarioCrearBean.modoIntercambio }"
                                    />

                                <p:commandButton value="Intercambiar Horas"
                                                 icon="pi pi-refresh"
                                                 actionListener="#{horarioCrearBean.activarModoIntercambio}"
                                                 process="@this"
                                                 update="panelBotones grupo
                                                 carrera periodo semestre asignatura aulas grupos capgrupos panelBotonesModoGrupoAulas"
                                                 oncomplete="activarModoIntercambiar();"  
                                                 styleClass="btn-inst btn-inst-intercambiar"
                                                 disabled="#{!horarioCrearBean.booleanBotonIntercambiar 
                                                             or horarioCrearBean.eliminando 
                                                             or horarioCrearBean.activarModificar}"
                                                 />

                            </p:panelGrid>



                        </p:panel>

                        <h:inputHidden id="posicionesSeleccionadas" value="#{horarioCrearBean.posicionesSeleccionadas}" />
                        <!-- Input hidden para almacenar nombre de la materia seleccionada -->
                        <h:inputHidden id="nombreMateriaEliminar" value="#{horarioCrearBean.nombreMateriaSeleccionada}" />
                        <h:inputHidden id="aulaMateriaEliminar" value="#{horarioCrearBean.aulaMateriaSeleccionada}" />

                        <h:inputHidden id="nombreMateriaModificar" value="#{horarioCrearBean.nombreMateriaSeleccionada}" />
                        <h:inputHidden id="aulaMateriaModificar" value="#{horarioCrearBean.aulaMateriaSeleccionada}" />
                        <h:inputHidden id="filaMateriaModificar" value="#{horarioCrearBean.filaMateriaSeleccionada}" />
                        <h:inputHidden id="columnaMateriaModificar" value="#{horarioCrearBean.columnaMateriaSeleccionada}" />

                        <p:remoteCommand name="asignarMateriaSeleccionadaRCA"
                                         actionListener="#{horarioCrearBean.asignarMateriaSeleccionadaRCA}"
                                         update="confirmEliminarDialog growl grupo grupoEliminar"
                                         process="@this"
                                         oncomplete="
                                         if (args.abrirDialogo) {
                                         PF('confirmEliminarDialogWidget').show();
                                         }
                                         " />




                        <p:remoteCommand name="asignarMateriaSeleccionadaRCG"
                                         actionListener="#{horarioCrearBean.asignarMateriaSeleccionadaRCG}"
                                         update="confirmEliminarDialog growl grupo grupoEliminar"
                                         process="@this"
                                         oncomplete="if (args.abrirDialogo) {
                                         PF('confirmEliminarDialogWidget').show();
                                         }" />

                        <p:remoteCommand name="asignarMateriaSeleccionadaM" 
                                         actionListener="#{horarioCrearBean.asignarMateriaSeleccionadaM}"                                         
                                         oncomplete="
                                         if (args.abrirDialogo) {
                                         PF('confirmModificarDialogWidget').show();
                                         }"
                                         update="confirmModificarDialog growl grupo"
                                         process="@this" />

                        <p:remoteCommand name="asignarMateriaIntercambiarG" 
                                         actionListener="#{horarioCrearBean.cambiarMateriaSeleccionadaXG}"                                         
                                         oncomplete=""
                                         update="grupo growl"
                                         process="@this" />
                        
                        <p:remoteCommand name="asignarMateriaIntercambiarA" 
                                         actionListener="#{horarioCrearBean.cambiarMateriaSeleccionadaXA}"                                         
                                         oncomplete=""
                                         update="grupo growl"
                                         process="@this" />

                        <p:remoteCommand name="moverMateriaSeleccionada"
                                         actionListener="#{horarioCrearBean.moverMateriaSeleccionada}"
                                         process="@this"
                                         update="grupo growl">
                        </p:remoteCommand>

                        <p:remoteCommand name="mostrarNotificacionCeldaMateria"
                                         actionListener="#{horarioCrearBean.mostrarNotificacionCeldaMateria}"
                                         update="growl" />




                    
 
                        

                        <p:dataTable value="#{horarioCrearBean.listaHorarioCrear}" id="grupo" var="item" styleClass="tabla-horario" editable="true" editMode="cell" widgetVar="tablaWidget" size="small" showGridlines="true" >
                            <p:ajax event="cellEdit" listener="#{horarioCrearBean.onCellEdit}" update="grupo"/>                           


                            <p:column field="hora" headerText="Hora" sortable="false" filterable="false" selectRow="true" style="text-align: center;">
                                <f:facet name="header">
                                    <h:outputText value="Hora"/>
                                </f:facet>
                                <h:outputText value="#{item.hora}"/>
                            </p:column>
                            <p:column headerText="Lunes" style="padding:0; height:50px; text-align: center;">
                                <f:facet name="header">
                                    <h:outputText value="Lunes"/>
                                </f:facet>

                                <h:panelGroup style="
                                              display:flex;
                                              justify-content:center;  /* centra horizontal */
                                              align-items:center;      /* centra vertical */
                                              text-align:center;
                                              width:100%;
                                              height:100%;
                                              background-color: #{not empty item.lunes ? horarioCrearBean.getSepararAtributos(item.lunes,1) : 'transparent'};
                                              color: #{horarioCrearBean.getSepararAtributos(item.lunes,2)};
                                              "
                                              >
                                    <h:outputText value="#{horarioCrearBean.booleanBuscarAula 
                                                           ? horarioCrearBean.getSepararAtributos(item.lunes,4)
                                                           : horarioCrearBean.getSepararAtributos(item.lunes,0)}"/>
                                </h:panelGroup>
                            </p:column>

                            <p:column headerText="Martes" style="padding:0; height:50px; text-align: center;">
                                <f:facet name="header">
                                    <h:outputText value="Martes"/>
                                </f:facet>
                                <h:panelGroup style="
                                              display:flex;
                                              justify-content:center;
                                              align-items:center;
                                              text-align:center;
                                              width:100%;
                                              height:100%;
                                              background-color: #{not empty item.martes ? horarioCrearBean.getSepararAtributos(item.martes,1) : 'transparent'};
                                              color: #{horarioCrearBean.getSepararAtributos(item.martes,2)};
                                              "
                                              >
                                    <h:outputText value="#{horarioCrearBean.booleanBuscarAula 
                                                           ? horarioCrearBean.getSepararAtributos(item.martes,4)
                                                           : horarioCrearBean.getSepararAtributos(item.martes,0)}"/>
                                </h:panelGroup>
                            </p:column>

                            <p:column headerText="Mi√©rcoles" style="padding:0; height:50px; text-align: center;">
                                <f:facet name="header">
                                    <h:outputText value="Mi√©rcoles"/>
                                </f:facet>
                                <h:panelGroup style="
                                              display:flex;
                                              justify-content:center;
                                              align-items:center;
                                              text-align:center;
                                              width:100%;
                                              height:100%;
                                              background-color: #{not empty item.miercoles ? horarioCrearBean.getSepararAtributos(item.miercoles,1) : 'transparent'};
                                              color: #{horarioCrearBean.getSepararAtributos(item.miercoles,2)};
                                              "
                                              >

                                    <h:outputText value=" #{horarioCrearBean.booleanBuscarAula 
                                                            ? horarioCrearBean.getSepararAtributos(item.miercoles,4)
                                                            : horarioCrearBean.getSepararAtributos(item.miercoles,0)}"/>
                                </h:panelGroup>
                            </p:column>

                            <p:column headerText="Jueves" style="padding:0; height:50px; text-align: center;">
                                <f:facet name="header">
                                    <h:outputText value="Jueves"/>
                                </f:facet>
                                <h:panelGroup style="
                                              display:flex;
                                              justify-content:center;
                                              align-items:center;
                                              text-align:center;
                                              width:100%;
                                              height:100%;
                                              background-color: #{not empty item.jueves ? horarioCrearBean.getSepararAtributos(item.jueves,1) : 'transparent'};
                                              color: #{horarioCrearBean.getSepararAtributos(item.jueves,2)};
                                              "
                                              >
                                    <h:outputText value="#{horarioCrearBean.booleanBuscarAula 
                                                           ? horarioCrearBean.getSepararAtributos(item.jueves,4)
                                                           : horarioCrearBean.getSepararAtributos(item.jueves,0)}"/>
                                </h:panelGroup>
                            </p:column>

                            <p:column headerText="Viernes" style="padding:0; height:50px; text-align: center;">
                                <f:facet name="header">
                                    <h:outputText value="Viernes"/>
                                </f:facet>
                                <h:panelGroup style="
                                              display:flex;
                                              justify-content:center;
                                              align-items:center;
                                              text-align:center;
                                              width:100%;
                                              height:100%;
                                              background-color: #{not empty item.viernes ? horarioCrearBean.getSepararAtributos(item.viernes,1) : 'transparent'};
                                              color: #{horarioCrearBean.getSepararAtributos(item.viernes,2)};
                                              ">
                                    <h:outputText value="#{horarioCrearBean.booleanBuscarAula 
                                                           ? horarioCrearBean.getSepararAtributos(item.viernes,4)
                                                           : horarioCrearBean.getSepararAtributos(item.viernes,0)}"/>
                                </h:panelGroup>
                            </p:column>

                            <p:column headerText="S√°bado" style="padding:0; height:50px; text-align: center;">
                                <f:facet name="header">
                                    <h:outputText value="S√°bado"/>
                                </f:facet>
                                <h:panelGroup style="
                                              display:flex;
                                              justify-content:center;
                                              align-items:center;
                                              text-align:center;
                                              width:100%;
                                              height:100%;
                                              background-color: #{not empty item.sabado ? horarioCrearBean.getSepararAtributos(item.sabado,1) : 'transparent'};
                                              color: #{horarioCrearBean.getSepararAtributos(item.sabado,2)};

                                              " >
                                    <h:outputText value="#{horarioCrearBean.booleanBuscarAula 
                                                           ? horarioCrearBean.getSepararAtributos(item.sabado,4)
                                                           : horarioCrearBean.getSepararAtributos(item.sabado,0)}"/>
                                </h:panelGroup>
                            </p:column>
                        </p:dataTable>


                        <script type="text/javascript">

                            //Asignar a cada celda (td) de la tabla del horario dos atributos personalizados:
                            //      *data-row ‚Üí el n√∫mero de fila
                            //      *data-col ‚Üí el n√∫mero de columna
                            //Estos se usan despu√©s para identificar f√°cilmente la posici√≥n de una celda seleccionada.
                            function asignarDataset() {
                            //Busca todas las filas tr dentro del tbody de la tabla cuyo id es horarioG:grupo.
                            const rows = document.querySelectorAll('#horarioG\\:grupo tbody tr');
                            //Recorre cada fila y obtiene todas sus celdas td
                            rows.forEach(function (row, rowIndex) {
                            const cells = row.querySelectorAll('td');
                            //Aqu√≠ se agregan atributos personalizados data-row y data-col a cada celda.
                            cells.forEach(function (cell, colIndex) {
                            cell.dataset.row = rowIndex;
                            cell.dataset.col = colIndex;
                            });
                            });
                            console.log(" asignarDataset() se ejecut√≥");
                            }
                        </script>   

                        <script>
                            // ===============================
                            // Modos
                            // ===============================
                            let modoEliminar = false;
                            let modoModificar = false;
                            let modoIntercambiar = false;
                            let celdaMateriaSeleccionada = null; // Celda de la materia que vamos a mover
                            let modoAgregar = false;
                            let modoAula = false;
                            let modoGrupo = false;
                            //Activar ModoAula
                            function activarModoAula(){
                            modoAula = !modoAula;
                            }
                            //Activar modoGrupo
                            function activarModoGrupo(){
                            modoGrupo = !modoGrupo;
                            }
                            // ===============================
                            // Variables para intercambio
                            // ===============================
                            let celdaSeleccionadaIntercambio = null;
                            // ===============================
                            // Funciones para activar modos
                            // ===============================
                            // ================== ACTIVAR MODOS ==================
                            function activarModoEliminarJS() {
                            modoEliminar = !modoEliminar;
                            modoModificar = false;
                            modoIntercambiar = false;
                            actualizarCursorCeldas();
                            console.log("Modo eliminar:", modoEliminar);
                            }

                            function activarModoModificarJS() {
                            modoModificar = !modoModificar;
                            modoEliminar = false;
                            modoIntercambiar = false;
                            actualizarCursorCeldas();
                            console.log("Modo modificar:", modoModificar);
                            }

                            function activarModoIntercambiar() {
                            modoIntercambiar = !modoIntercambiar;
                            modoEliminar = false;
                            modoModificar = false;
                            actualizarCursorCeldas();
                            console.log("Modo intercambio activo:", modoIntercambiar);
                            }

                            function desactivandoModoTodo() {
                            modoIntercambiar = false;
                            modoEliminar = false;
                            modoModificar = false;
                            actualizarCursorCeldas();
                            }

                            // ================== ACTUALIZAR CURSOR ==================
                            function actualizarCursorCeldas() {
                            document.querySelectorAll('#horarioG\\:grupo tr').forEach(fila => {
                            const celdas = fila.querySelectorAll('td');
                            celdas.forEach((td, index) => {
                            if (index > 0 &amp;&amp; td.textContent.trim()) {
                            td.style.cursor = (modoEliminar || modoModificar || modoIntercambiar) ? 'pointer' : 'default';
                            } else {
                            td.style.cursor = (modoIntercambiar) ? 'pointer' : 'default';
                            }
                            });
                            });
                            }

                            // ===============================
                            // Escucha global de clicks
                            // ===============================
                            document.addEventListener('click', function(e) {
                            const td = e.target.closest('td');
                            if (!td || !td.closest('#horarioG\\:grupo')) return;
                            const contenido = td.textContent.trim();
                            const partes = contenido.split("  ");
                            const nombre = partes[0];
                            const aula = partes[1] || "";
                            const tr = td.parentElement;
                            const fila = td.parentElement.rowIndex;
                            const columna = td.cellIndex;
                            // ===============================
                            // Modo eliminar
                            // ===============================

                            // --- MODO ELIMINAR ---
                            if (modoEliminar &amp;&amp; contenido !== "") {

                            if (modoAula){
                            const carrera = partes[4];
                            const semestre = partes[3];
                            const valorgrupo = partes[2];
                            asignarMateriaSeleccionadaRCA([
                            { name: 'nombre', value: nombre },
                            { name: 'aula', value: aula },
                            { name: 'carrera', value: carrera },
                            { name: 'semestre', value: semestre },
                            { name: 'valorgrupo', value: valorgrupo }
                            ]);
                            }
                            
                            if (modoGrupo){
                            asignarMateriaSeleccionadaRCG([
                            { name: 'nombre', value: nombre },
                            { name: 'aula', value: aula }
                            ]);
                            document.getElementById('horarioG:nombreMateriaEliminar').value = nombre;
                            document.getElementById('horarioG:aulaMateriaEliminar').value = aula;
                            }

                            //PF('confirmEliminarDialogWidget').show();
                            return;
                            }
                            // ===============================
                            // Modo modificar
                            // ===============================

                            // --- MODO MODIFICAR ---
                            if (modoModificar &amp;&amp; contenido !== "") {
                            asignarMateriaSeleccionadaM([
                            { name: 'nombre', value: nombre },
                            { name: 'aula', value: aula },
                            { name: 'fila', value: fila },
                            { name: 'columna', value: columna }
                            ]);
                            document.getElementById('horarioG:nombreMateriaModificar').value = nombre;
                            document.getElementById('horarioG:aulaMateriaModificar').value = aula;
                            document.getElementById('horarioG:filaMateriaModificar').value = fila;
                            document.getElementById('horarioG:columnaMateriaModificar').value = columna;
                            //PF('confirmModificarDialogWidget').show();
                            return;
                            }
                            // ===============================
                            // Modo modificar
                            // ===============================
                            if (modoIntercambiar) {
                            // panelGroup dentro del td
                            const panel = td.querySelector('div,h3,span,p') || td;
                            // Si a√∫n hay celda seleccionada desde antes, y lo que se selecciono es una celda con texto, vuelvo a seleccionar
                            if (celdaSeleccionadaIntercambio &amp;&amp; panel.textContent.trim() !== ""){
                            mostrarNotificacionCeldaMateria();
                            celdaSeleccionadaIntercambio = null;
                            console.log("HABIA MATERIA SELECCIONADA ANTES PERO AHORA SELECCIONO OTRA");
                            }

                            if (!celdaSeleccionadaIntercambio) {
                            if (panel.textContent.trim() !== "") { // Solo si tiene contenido (materia)

                            celdaSeleccionadaIntercambio = panel;
                            // Guardar la informaci√≥n de la materia seleccionada
                            
                            if(modoAula){
                            const carrera = partes[4];
                            const semestre = partes[3];
                            const valorgrupo = partes[2];
                            asignarMateriaIntercambiarA([
                            { name: 'nombre', value: nombre },
                            { name: 'aula', value: aula },
                            { name: 'fila', value: fila },
                            { name: 'columna', value: columna },
                            { name: 'carrera', value: carrera },
                            { name: 'semestre', value: semestre },
                            { name: 'valorgrupo', value: valorgrupo }
                            ]);
                                
                            }
                            
                            if(modoGrupo){
                            asignarMateriaIntercambiarG([
                            { name: 'nombre', value: nombre },
                            { name: 'aula', value: aula },
                            { name: 'fila', value: fila },
                            { name: 'columna', value: columna }
                            ]);  
                                
                                
                            }
                           
                            console.log("ENTRE PARA SELECCIONAR MATERIA A MOVER");
                            }
                            }
                            // Si ya hay una materia seleccionada y se hace clic en otra celda
                            else {
                            // Evitar seleccionar otra materia (solo celdas vac√≠as)
                            if (panel.textContent.trim() === "") {
                            // Obtener la fila y columna de destino
                            const filaDestino = fila;
                            const columnaDestino = columna;
                            // Puedes enviar estos valores al bean
                            moverMateriaSeleccionada([
                            { name: 'filaDestino', value: filaDestino },
                            { name: 'columnaDestino', value: columnaDestino }
                            ]);
                            //console.log("Enviando a moverMateriaSeleccionada:", filaDestino, columnaDestino, aulaDestino);
                            console.log("Contenido{", contenido, "}")
                            console.log("Enviando a 1moverMateriaSeleccionada:", filaDestino, columnaDestino);
                            // Quitar el resaltado

                            console.log("ENTRE PARA MOVER MATERIA A DESTINO");
                            celdaSeleccionadaIntercambio = null;
                            } else {

                            //mostrarNotificacionCeldaMateria();
                            //console.log("No puedes mover la materia a una celda ocupada");
                            // Si se hace clic en otra materia, no permitir mover ah√≠
                            //celdaSeleccionadaIntercambio = null;
                            }
                            }
                            }
                            });
                            // ============================
                            // üîπ EFECTO HOVER
                            // ============================
                            document.addEventListener('mouseover', function(e) {
                            const td = e.target.closest('td');
                            if (!td || !td.closest('#horarioG\\:grupo')) return;
                            if (modoIntercambiar &amp;&amp; td.textContent.trim()) {
                            td.classList.add('celda-hover-intercambio');
                            console.log("EFECTO HOVER: INTERCAMBIO");
                            } else if (modoModificar &amp;&amp; td.textContent.trim()) {
                            console.log("EFECTO HOVER: MODIFICAR");
                            td.classList.add('celda-hover-modificar');
                            } else if (modoEliminar &amp;&amp; td.textContent.trim()) {
                            console.log("EFECTO HOVER: ELIMINAR");
                            td.classList.add('celda-hover-eliminar');
                            } else if (modoAgregar &amp;&amp; td.textContent.trim() === "") {
                            console.log("EFECTO HOVER: AGREGAR");
                            td.classList.add('celda-hover-agregar');
                            }
                            });
                            document.addEventListener('mouseout', function(e) {
                            const td = e.target.closest('td');
                            if (!td || !td.closest('#horarioG\\:grupo')) return;
                            td.classList.remove('celda-hover-intercambio');
                            td.classList.remove('celda-hover-modificar');
                            td.classList.remove('celda-hover-eliminar');
                            td.classList.remove('celda-hover-agregar');
                            });
                        </script>
                        <script type="text/javascript">
                            //Espera a que toda la p√°gina HTML + tabla termine de cargarse antes de ejecutar el c√≥digo.
                            document.addEventListener('DOMContentLoaded', function () {
                            asignarDataset();
                            });
                        </script>                        


                        <script type="text/javascript">
                            //Escucha clics en todo el documento
                            //Este script controla la selecci√≥n de celdas vac√≠as dentro de la tabla del horario cuando el usuario est√° en modo de crear horario.
                            //  * No act√∫a si se est√° eliminando materias.
                            //  *Solo permite seleccionar celdas vac√≠as.
                            //  *Respeta un l√≠mite m√°ximo de selecci√≥n.
                            //  *Marca o desmarca visualmente las celdas con una clase CSS (celda-seleccionada).
                            //  *Habilita el bot√≥n de guardar cuando se llega al l√≠mite.
                            document.addEventListener('click', function (e) {
                            // Si est√° en modo eliminar, no permitir selecci√≥n de celdas vac√≠as
                            if (typeof modoEliminar !== 'undefined' &amp;&amp; modoEliminar) {
                            return;
                            }

                            if (typeof modoModificar !== 'undefined' &amp;&amp; modoModificar) {
                            return;
                            }

                            if (typeof modoIntercambiar !== 'undefined' &amp;&amp; modoIntercambiar) {
                            return;
                            }

                            var td = e.target.closest('td');
                            if (!td)
                                    return; // Si no es una celda, salir
                            //Busca si el clic fue dentro de la tabla "horarioG:grupo"
                            if (td.closest('#horarioG\\:grupo')) {

                            //Revisa si la celda est√° vac√≠a
                            var contenido = td.textContent.trim();
                            // Solo celdas vac√≠as
                            if (contenido === '') {
                            // Ver cu√°ntas ya est√°n seleccionadas
                            var seleccionadas = document.querySelectorAll('#horarioG\\:grupo td.celda-seleccionada').length;
                            if (!td.classList.contains('celda-seleccionada')) {
                            // Si a√∫n no est√° seleccionada y se excede el m√°ximo, no hacer nada
                            var boton = document.getElementById('horarioG:btnguardar');
                            if (seleccionadas >= maximoSeleccion) {
                            boton.disabled = false; // Activa el bot√≥n
                            // Opcional: mostrar alerta o mensaje visual

                            console.log("L√≠mite de selecci√≥n alcanzado.");
                            console.log("seleccionadas: " + seleccionadas);
                            console.log("maximoSeleccion: " + maximoSeleccion);
                            return;
                            } else {

                            }
                            }
                            //td.textContent = asignaturaSel; 
                            // Alternar la selecci√≥n, Marca o desmarca la celda
                            td.classList.toggle('celda-seleccionada');
                            }
                            }
                            });
                        </script>


                        <script type="text/javascript">

                            //Guardar las posiciones (fila y columna) de todas las celdas seleccionadas en la tabla del horario dentro de un input hidden para enviarlas al backend.
                            function guardarSeleccionadas() {
                            asignarDataset();
                            // Selecciona todas las celdas seleccionadas
                            const celdas = document.querySelectorAll('#horarioG\\:grupo td.celda-seleccionada');
                            const posiciones = [];
                            console.log("Celdas seleccionadas:", celdas); //  mira qu√© celdas encuentra

                            celdas.forEach(function (celda, index) {
                            const fila = parseInt(celda.dataset.row) + 1;
                            const columna = celda.dataset.col;
                            console.log(`Celda ${index}: fila=${fila}, columna=${columna}`); // revisa los atributos

                            posiciones.push(fila + "," + columna);
                            });
                            const valorFinal = posiciones.join(";");
                            console.log("Valor que se va a enviar al input hidden:", valorFinal); // revisa el string final

                            const input = document.getElementById('horarioG:posicionesSeleccionadas');
                            console.log("Input hidden encontrado:", input); // revisa que exista

                            if (input) {
                            input.value = valorFinal;
                            } else {
                            console.log("ERROR: No se encontr√≥ el input hidden.");
                            }
                            guardarSeleccionadas();
                            setTimeout(function() {
                            window.onbeforeunload = function() {
                            return "Si recargas la p√°gina, los datos del formulario se perder√°n.";
                            };
                            }, 1000);
                            }
                        </script>
                        <h:outputScript>
                            window.onbeforeunload = function(event) {
                            return "Si recargas la p√°gina, los datos del formulario se perder√°n.";
                            };
                        </h:outputScript>
                        <style>
                           
                        </style>
                        <!-- VENTANA EMERGENTE PARA ELIMINAR UNA MATERIA -->
                        <p:confirmDialog id="confirmEliminarDialog"
                                         widgetVar="confirmEliminarDialogWidget"
                                         header="Confirmar eliminaci√≥n"
                                         message="¬øEst√°s seguro de eliminar los datos seleccionados?"                                          
                                         severity="warn"
                                         closable="false"
                                         width="900"
                                         styleClass="confirm-dialog-eliminar">
                            <!-- ‚úÖ Muestra la materia que ha sido seleccionada de la tabla. -->
                            <h:panelGrid columns="1" cellpadding="5">

                                <!-- üîπ Tabla con los datos del horario a eliminar -->
                                <p:dataTable value="#{horarioCrearBean.listaHorarioBorrar}"
                                             id="grupoEliminar"
                                             var="item"
                                             editable="true"
                                             editMode="cell"
                                             widgetVar="tablaWidgetEliminar"
                                             size="small"
                                             showGridlines="true">
                                    <p:ajax event="cellEdit" listener="#{horarioCrearBean.onCellEdit}" update="grupoEliminar"/>                           

                                    <!-- Columnas -->
                                    <p:column headerText="Materia" style="text-align:center; word-wrap: break-word; overflow-wrap: break-word;">
                                        <h:outputText value="#{item.hora}" style="font-size:0.8em; text-align:center; display:block;"/>
                                    </p:column>

                                    <p:column headerText="Lunes" style="text-align:center; width:auto; padding:2px;">
                                        <h:outputText value="#{item.lunes}" style="text-align:center;"/>
                                    </p:column>

                                    <p:column headerText="Martes" style="text-align:center; width:auto; padding:2px;">
                                        <h:outputText value="#{item.martes}" style="text-align:center;"/>
                                    </p:column>

                                    <p:column headerText="Mi√©rcoles" style="text-align:center; width:auto; padding:2px;">
                                        <h:outputText value="#{item.miercoles}" style="text-align:center;"/>
                                    </p:column>

                                    <p:column headerText="Jueves" style="text-align:center; width:auto; padding:2px;">
                                        <h:outputText value="#{item.jueves}" style="text-align:center;"/>
                                    </p:column>

                                    <p:column headerText="Viernes" style="text-align:center; width:auto; padding:2px;">
                                        <h:outputText value="#{item.viernes}" style="text-align:center;"/>
                                    </p:column>

                                    <p:column headerText="S√°bado" style="text-align:center; width:auto; padding:2px;">
                                        <h:outputText value="#{item.sabado}" style="text-align:center;"/>
                                    </p:column>
                                </p:dataTable>

                            </h:panelGrid>

                             <h:panelGroup layout="block"
                      style="display:flex; justify-content:center; gap:2rem; margin-top:1rem;">

                            <p:commandButton value="S√≠, eliminar"
                                             icon="pi pi-check"
                                             styleClass="ui-button-danger"
                                             actionListener="#{horarioCrearBean.confirmarEliminarMateria}"
                                             oncomplete="PF('confirmEliminarDialogWidget').hide();"
                                             process="@this nombreMateriaEliminar aulaMateriaEliminar"
                                             update="grupo growl" />

                            <p:commandButton value="Cancelar"
                                             icon="pi pi-times"
                                             actionListener="#{horarioCrearBean.limpiarVariablesDeEstadoEliminar}"
                                             styleClass="ui-button-secondary"
                                             oncomplete="PF('confirmEliminarDialogWidget').hide();"                      
                                             update="grupo growl"
                                             onclick="PF('mockEliminarDialog').hide();"/>
                                             />
                            
                            
                             </h:panelGroup>

                        </p:confirmDialog>
                        
                        
                        <!-- ‚úÖ VENTANA EMERGENTE DE MODIFICAR AULA -->
                        <p:dialog id="confirmModificarDialog"
                                  header="Modificar Aula"
                                  widgetVar="confirmModificarDialogWidget"
                                  modal="true"
                                  closable="false"
                                  responsive="true"
                                  style="max-width:450px;"
                                  styleClass="dialog-modificar-aula">

                            <!-- FORMULARIO ORDENADO -->
                            <h:panelGrid columns="1" style="width:100%;" cellspacing="8">

                                <!-- Grupo: Materia -->
                                <h:panelGrid columns="2" style="width:100%;" columnClasses="col-label,col-value">

                                    <h:outputText value="Materia:" style="font-weight:bold;" />
                                    <h:outputText value="#{horarioCrearBean.nombreMateriaSeleccionada}" 
                                                  style="color:#2c3e50;" />

                                </h:panelGrid>

                                <!-- Grupo: Aula actual -->
                                <h:panelGrid columns="2" style="width:100%;" columnClasses="col-label,col-value">

                                    <h:outputText value="Aula actual:" style="font-weight:bold;" />
                                    <h:outputText value="#{horarioCrearBean.aulaMateriaSeleccionada}" 
                                                  style="color:#2c3e50;" />

                                </h:panelGrid>

                                <!-- Grupo: Nueva aula -->
                                <h:panelGrid columns="2" style="width:100%;" columnClasses="col-label,col-value">

                                    <h:outputText value="Nueva aula:" style="font-weight:bold;" />

                                    <p:selectOneMenu value="#{horarioCrearBean.nuevaAulaSeleccionada}"
                                                     style="width:100%; font-weight:bold;"
                                                     >

                                        <p:ajax />

                                        <f:selectItem itemLabel="Seleccione un aula" 
                                                      itemValue="" 
                                                      noSelectionOption="true" />

                                        <f:selectItems value="#{horarioCrearBean.listaAulas}" 
                                                       var="a" 
                                                       itemLabel="#{a.aula}" 
                                                       itemValue="#{a.aula}" />
                                    </p:selectOneMenu>

                                </h:panelGrid>

                            </h:panelGrid>

                            <p:separator />

                            <!-- BOTONES ALINEADOS A LA DERECHA -->
                            <h:panelGroup layout="block" 
                                          style="display:flex; justify-content:flex-end; gap:1rem; width:100%; margin-top:1rem;">

                                <!-- Confirmar (azul profesional) -->
                                <p:commandButton value="Confirmar"
                                                 icon="pi pi-check"
                                                 process="@form"
                                                 style="background:#1A73E8; border:none; color:white; font-weight:bold;
                                                 padding:0.6rem 1.4rem; border-radius:6px;"
                                                 actionListener="#{horarioCrearBean.confirmarModificarMateria}"
                                                 update="grupo growl panelBotones"
                                                 oncomplete="PF('confirmModificarDialogWidget').hide();" />

                                <!-- Cancelar (gris elegante) -->
                                <p:commandButton value="Cancelar"
                                                 icon="pi pi-times"
                                                 style="background:#6c757d; border:none; color:white; font-weight:bold;
                                                 padding:0.6rem 1.4rem; border-radius:6px;"
                                                 actionListener="#{horarioCrearBean.limpiarVariablesDeEstadoModificar}"
                                                 onclick="PF('confirmModificarDialogWidget').hide();"
                                                 update="grupo"
                                                 />

                            </h:panelGroup>

                        </p:dialog>


                    </h:form>
                </f:view>
                  

            </ui:define>

        </ui:composition>

    </body>
</html>


